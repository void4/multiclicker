<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="img/time.png">
<title>Multiclicker</title>

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-142188591-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/aegyptusb" type="text/css"/>
<style>

@font-face {
    font-family: 'AegyptusBold';
        src: url('/fonts/AegyptusBold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

* {
    font-family: 'AegyptusBold';
    font-weight: bold;
    font-style: normal;
    font-size: 1.05em;
}

button {
  background-image: url("img/button.png");
  background-size:100% 100%;
  border:none;
}


button.highlight {
  background-image: none;
}

.background {
  z-index: -1;
  position: fixed;
  min-width: 100%;
  min-height: 100%;
  background-color: blue;
  overflow: hidden;

  background-image: url("img/nomad.png");
  background-size: 100% 100%;

  filter: blur(8px);
  margin-top: -8px;
  padding-bottom: 16px;
  margin-left: -8px;
  padding-right: 16px;
  transform: scale(1.08);

}

#map {
}

.travel {
  margin-left: 10%;
  margin-right: 10%;
}

.travelinfo {
  background-color: rgba(219, 209, 140, 0.55);
}

.highlight {
  background-color: green;
}

* {
  -ms-touch-action: manipulation;
  touch-action: manipulation;
}

.header img {
  float: right;
  position: absolute;
  width: auto;
  padding: 0;
}

.header h1 {
  position: relative;
}

@media only screen and (max-width: 800px) {
 body {
   width: 100%;
   min-width:100%;
   margin:0;
   padding:0;
 }

 .header img {
   position: relative;
 }
}

.infobutton {
  font-size:12px;
  color:white;
  background-color:rgba(50,50,50,0.2);
}

canvas {
  position: fixed;
  margin: 0;
  pointer-events:none;
}

.actionheader {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  text-align: center;
  font-size: 15px;
  font-weight: bold;
}

.core {
  font-size: 14px;
  text-align: center;
}

.bigactionheader {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  text-align:center;
  background-color:rgba(255,255,255,0.1);
  padding-top:0;
  margin-bottom: 10px;
  grid-column: 1/4;
}

.header {
  grid-column: 1/4;
}

.textcenter {
    text-align: center;
}

area {
  display: block;
  cursor: pointer;
}

.logininput {
  border: 0;
  outline: 0;
  background: transparent;
  border-bottom: 1px solid black;
}
</style>
<script type="text/javascript" src="js/socket.io.js"></script>
<script type="text/javascript" src="js/vue.min.js"></script>

<script>
var socket = window.location.hostname == "qewasd.com" ? io({path:"/multisocket/socket.io/"}) : io(":9999");

function send(type, data) {
  socket.emit("json", {"type":type, "data":data})
}

socket.on('connect', function(){
  var username = getCookie("username");
  var password = getCookie("password");

  if (username != "" && password != "") {
    send("savelogin", {"username":username, "password":password})
  }
  //var name = "" + new Date().getTime();
  //send("login", {"name":name})
});

socket.on('event', function(data){
  console.log(data)
});

socket.on('json', function(message){
  var username = document.querySelector("#username")
  var password = document.querySelector("#password")
  //console.log(message)
  var type = message["type"]
  var data = message["data"]
  console.log(type, data)
  if (type == "login") {
    console.log("LOGIN:", data)
    app.online = true;
    setCookie("username", username.value)
    setCookie("password", password.value)
  } else if (type == "randomname") {

    //if (username.value=="") {
    username.value = data;
    //}
  } else if (type == "player") {
    app.player = data;
  } else if (type == "markets") {
    app.markets = data;
    if (Object.keys(app.market).length == 0) {
      app.getMarket(app.markets[0])
    }
  } else if (type == "market") {
    app.market = data;
    app.order.price = data["lastprice"]
    app.order.estprice = data["lastprice"]
    app.order.item = data["item"]
  } else if (type == "cities") {
    app.cities = data;
  } else if (type == "routes") {
    app.routes = data;
  } else if (type == "items") {
    app.items = data;
  } else if (type == "travelinfo") {
    app.travelinfo = data;
  } else if (type == "city") {
    app.city = data;
    app.travelinfo = null;
  }
});

socket.on('message', function(data){
  console.log(data)
});

socket.on('disconnect', function(){

});

window.addEventListener("beforeunload", function() {
  console.log("Disconnecting...")
  socket.disconnect();
});

function joinDict(object, glue, separator) {

  if (glue == undefined)
    glue = ' ';

  if (separator == undefined)
    separator = ',';

  var result = "";

  for (const [ key, value ] of Object.entries(object)) {
    result += value + glue + key + separator
  }

  return result.slice(0, -1)
}

</script>
</head>
<body>
<div class="background"></div>

<div id="app">

  <div>
    <form onsubmit="event.preventDefault();">
    <input type="text" class="logininput" id="username" autocomplete="username" size="6"></input>
    <template v-if="!player.password">
      <button v-on:click="randomName()">Random name</button><br>
      <input type="password" class="logininput" id="password" autocomplete="current-password" size="6"></input>
      <button v-on:click="saveLogin()">Save and Login</button><br>
    </template>
    </form>
  </div>

  <div v-if="player" style="display:grid;grid-template-columns:75% 25%">

    <div v-if="player.inventory">
      <div style="display:grid;grid-template-columns:20% 80%;grid-auto-flow:row;">
        <div>
          <button v-on:click="logout()">Logout</button><br>
          <img src="img/time.png"></img>Time: {{player.inventory.time}}<br>
          <img src="img/weight.png"></img>Weight: {{player.weight}}/{{player.capacity}}<br>
        </div>

        <div style="display:grid;grid-template-columns:33% 33% 33%">



          <div>
            <h2 class="header">Inventory</h2>

            <div v-for="(value, key) in player.inventory">
              <div v-if="key!='time'">
                <img v-bind:src="'img/'+key+'.png'" alt=""></img>
                {{key}}: {{value}}
                <button  v-on:click="store(key)">Store</button>
              </div>
            </div>

            <!--
            Amount
            <input type="radio" v-model="storeamount" id="sa1" value="1"><label for="sa1">1</label></input>
            <input type="radio" v-model="storeamount" id="sa2" value="10"><label for="sa2">10</label></input>
            <input type="radio" v-model="storeamount" id="sa3" value="100"><label for="sa3">100</label></input>
            <input type="radio" v-model="storeamount" id="sa4" value="1000"><label for="sa4">1000</label></input>
            <input type="radio" v-model="storeamount" id="sa5" value="10000"><label for="sa5">10000</label></input>
            -->

          </div>

          <div>
            <h2 class="header">Local storage</h2>
            <div v-for="(value, key) in player.storage[player.location]">
              {{key}}: {{value}}
              <button v-on:click="unstore(key)">Unstore</button>
            </div>
          </div>

          <div v-if="cities">
            <h2 class="header">Crafting</h2>
            <div v-for="(value, key) in getCurrentCity().craftable">
              {{ key }} {{ key in items ? "("+items[key]['weight']+"w)" : "" }} : <button v-on:click="craft(key)">{{ joinDict(value[0]) }}</button>
            </div>
          </div>

        </div>
      </div>

        <div style="display:grid;grid-template-columns:10% 90%;grid-auto-flow:row;">

          <div>
            <h2>Goods</h2>

            <div v-for="(marketname, index) in markets">
              <button v-on:click="getMarket(marketname)" v-bind:class="{highlight: marketname==market.item}">{{marketname}}</button>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:50% 50%;">
            <h2 class="header">Local market - Currency: {{market.currency}}</h2>

            <div>
              <h3 class="bigactionheader">Orders</h3>

              <div>
                <h4 class="bigactionheader">Sells</h4>
                <div v-for="(order, index) in market.sells">
                  Price: {{order.price}} Volume: {{order.volume}} Total: {{order.price*order.volume}}
                  <button v-if="order.own" v-on:click="cancelOrder('sells', order.oid)">Cancel</button>
                  <button v-if="!order.own" v-on:click="acceptOrder('sells', order.oid)">Accept</button>
                </div>
              </div>

              <div>
                <h4 class="bigactionheader">Buys</h4>
                <!--Collate-->
                <div v-for="(order, index) in market.buys">
                  Price: {{order.price}} Volume: {{order.volume}} Total: {{order.price*order.volume}}
                  <button v-if="order.own" v-on:click="cancelOrder('buys', order.oid)">Cancel</button>
                  <button v-if="!order.own" v-on:click="acceptOrder('buys', order.oid)">Accept</button>
                </div>
              </div>
            </div>

            <div>
              <h3 class="bigactionheader">Chart</h3>
            </div>

            <br>
            <div style="display:grid;grid-template-columns:100% 50%;">
              <h3 class="bigactionheader">Order</h3>
              <div>
                <h4>Place order</h4>
                <input type="radio" v-model="order.bos" id="buy" value="buy"><label for="buy">Buy</label></input>
                <input type="radio" v-model="order.bos" id="sell" value="sell"><label for="sell">Sell</label></input>
                <br>
                <select class="logininput" v-model="order.type">
                  <!--<option disabled value="">Please select one</option>-->
                  <option value="limit">Limit</option>
                  <option value="market">Market</option>
                </select>Type
                <br>
                <input type="text" class="logininput" size="4" v-on:change="orderChange(0)" v-model.number="order.volume" type="number">Volume</input><br>
                <div v-if="order.type=='limit'">
                  <input type="text" class="logininput" size="4" v-on:change="orderChange(1)" v-model.number="order.price" type="number">Price</input><br>
                  <input type="text" class="logininput" size="4" v-on:change="orderChange(2)" v-model.number="order.cost" type="number">Cost</input><br>
                </div>
                <div v-if="order.type=='market'">
                  <input type="text" class="logininput" size="4" v-model.number="order.estprice" type="number" disabled>Estimated Price</input><br>
                  <input type="text" class="logininput" size="4" v-model.number="order.estcost" type="number" disabled>Estimated Cost</input><br>
                </div>
                <button v-on:click="submitOrder()">Submit</button><br>
              </div>

              <!--
              <div>
                <h4>My orders</h4>
                <div v-for="(order, index) in orders">
                  <button onclick="cancelOrder(order.id)">Cancel</button>
                </div>
              </div>
            -->
            </div>
          </div>
        </div>

      </div>

    <div class="travel">
      <canvas id="canvas" width="640" height="480"></canvas>
      <div>
        <h2 class="header">Map - {{ player.location }}</h2>
        <img id="map" src="img/overlay.jpg" usemap="#workmap">
        <map name="workmap">
          <div v-for="city in cities"><!--[0],city.coords[1],city.coords[2],city.coords[3]-->
            <area shape="rect" v-bind:coords="[city.coords[0]-10, city.coords[1]-10, city.coords[0]+10, city.coords[1]+10].join()" v-on:click="getTravelInfo(city.name)">
          </div>
        </map>
      </div>

      <div class="travelinfo" v-if="travelinfo">
        <h2 class="header">Travelinfo</h2>
        To {{ travelinfo.city }}
        <div v-for="(costs, mode) in travelinfo.costs">
          by {{ mode }}
          <div v-for="(value, key) in costs">
            {{key}}:{{value}}
          </div>
          <button v-on:click="travel(travelinfo.city, mode)">{{mode == "camel" ? "Depart" : "Set Sail"}}</button>
        </div>
      </div>

      <div v-if="!travelinfo">
      </div>
    </div>

  </div>
</div>

<a href="https://void4.github.io">
  <img id="ra" style="position:fixed; bottom: 0; right: 0px;" width="30" src="img/ra.png"></img>
</a>
<script>

function indexOfSmallest(a) {
 return a.indexOf(Math.min.apply(Math, a));
}

function count(array, el) {
  var count = 0;
  for(var i = 0; i < array.length; ++i){
      if(array[i] == el)
          count++;
  }
  return count;
}


var app = new Vue({
  el: '#app',
  data: {
    online: false,
    player: {},
    bos: "buy",
    orders: [],
    order: {bos: "buy", type: "limit"},
    markets: [],
    market: {},
    loc: [0, 0, 0],
    cities: [],
    routes: [],
    storeamount: 1,
    items: {},
    travelinfo: null,
    city: null,
  },
  methods: {
    decide(name) {
      socket.emit("json", {"type":"decision", "data":name})
    },
    getMarket(name) {
      send("market", name)
    },
    submitOrder() {
      send("order", app.order)
    },
    orderChange(index) {
      if (app.order.type=="limit") {
        app.loc[index] = new Date().getTime();

        if (count([app.order.volume, app.order.price, app.order.cost], null) < 2) {
          var smol = indexOfSmallest(app.loc)

          if (smol == 0) {
            app.order.volume = app.order.cost/app.order.price
          } else if (smol == 1) {
            app.order.price = app.order.cost/app.order.volume
          } else if (smol == 2) {
            app.order.cost = app.order.volume*app.order.price
          }
        }
      } else {
        if (app.order.estprice != null) {
          app.order.estcost = app.order.volume * app.order.estprice;
        }
      }
    },
    craft(item) {
      send("craft", {"item":item, "count": parseInt(app.storeamount)})
    },
    getTravelInfo(city) {
      send("getTravelInfo", city)
    },
    travel(city, mode) {
      send("travel", {"city":city, "mode":mode})
    },
    getCity(name) {
      for (var city of app.cities) {
        if (city.name == name) {
          return city
        }
      }
    },
    getCurrentCity() {
      return app.getCity(app.player.location)
    },
    store(key) {
      send("store", {"item":key, "count":parseInt(app.storeamount)})
    },
    unstore(key) {
      send("unstore", {"item":key, "count":parseInt(app.storeamount)})
    },
    cancelOrder(bos, oid) {
      send("cancelOrder", {"bos":bos, "oid":oid})
    },
    acceptOrder(bos, oid) {
      send("acceptOrder", {"bos":bos, "oid":oid})
    },
    saveLogin() {
      var username = document.querySelector("#username").value
      var password = document.querySelector("#password").value
      send("savelogin", {"username":username, "password":password})
    },
    logout() {
      send("logout", null)
      app.player = {};
      app.market = [];
      app.markets = [];
      app.orders = [];
      app.routes = [];
      app.online = false;
      setCookie("username", "")
      setCookie("password", "")
    },
    randomName() {
      send('randomname', null)
    }
  }
});



var canvas = document.querySelector('canvas')
var ctx = canvas.getContext("2d")

function draw() {

  if (app.player == null) {
    return;
  }

  var map = document.getElementById("map")

  if (!map) {
    return;
  }

  var rect = map.getBoundingClientRect();

  canvas.style.left = rect.left + "px";
  canvas.style.top = rect.top + "px";

  ctx.canvas.width  = rect.width;
  ctx.canvas.height = rect.height;

  ctx.drawImage(map, 0, 0)

  var city = app.getCurrentCity()

  if (city) {
    for (var route of app.routes) {
      var other = null;
      if (route[0]==city.name) {
        other = app.getCity(route[1])
      } else if (route[1]==city.name) {
        other = app.getCity(route[0])
      }

      if (other!=null) {
        for (const [mode, length] of Object.entries(route[2])) {
          ctx.beginPath();

          if (mode == "ship") {
            ctx.lineWidth = "4";
            ctx.strokeStyle = `rgb(0,0,${200-length})`;
          } else if (mode == "camel") {
            ctx.lineWidth = "8";
            ctx.strokeStyle = `rgb(${200-length},0,0)`;
          }
          ctx.moveTo(city.coords[0], city.coords[1])
          ctx.lineTo(other.coords[0], other.coords[1]);
          ctx.stroke();
        }
      }
    }

    ctx.beginPath();
    ctx.lineWidth = "6";
    ctx.strokeStyle = "red";
    ctx.rect(city.coords[0], city.coords[1], city.coords[2], city.coords[3]);
    ctx.stroke();
  }


}

document.addEventListener('readystatechange', event => {
    if (event.target.readyState === "interactive") {
        setInterval(draw, 25)
    }
})

function getCursorPosition(canvas, event) {
    const rect = canvas.getBoundingClientRect()
    const x = event.clientX - rect.left
    const y = event.clientY - rect.top
    console.log("x: " + x + " y: " + y)
}

canvas.addEventListener('mousemove', function(e) {
    //getCursorPosition(canvas, e)
})


function setCookie(cname, cvalue, exdays) {
  if (exdays==undefined) {
    exdays = 7;
  }
  var d = new Date();
  d.setTime(d.getTime() + (exdays*24*60*60*1000));
  var expires = "expires="+ d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

</script>
</body>
</html>
